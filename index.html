<!DOCTYPE html>
<html>
  <head>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background: rgba(119, 119, 119, 0.1);
        overflow: hidden;
        border-radius: 12px;
      }

      .content {
        padding: 20px;
        height: 100vh;
        box-sizing: border-box;
        background: rgba(121, 121, 121, 0.5);
        border-right: 1px solid rgba(0, 0, 0, 0.1);
        position: relative;
        display: flex;
        flex-direction: column;
        border-radius: 12px;
      }

      .header {
        margin-bottom: 20px;
        padding-bottom: 10px;
        background: rgba(255, 255, 255, 1);
        border-bottom: 1px solid rgba(255, 255, 255, 1);
        position: relative;
        padding: 12px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .header-left {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        flex: 1;
      }

      .header-left h1 {
        margin: 0;
        margin-bottom: 5px;
        font-size: 20px;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .header h3 {
        margin: 0;
        margin-right: 15px;
      }

      .close-button,
      .position-toggle,
      .vertical-toggle {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 4px;
        margin-right: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s;
        font-family: "Material Icons";
        font-size: 20px;
      }

      .close-button:hover,
      .position-toggle:hover,
      .vertical-toggle:hover {
        color: #333;
      }

      .search-box {
        width: 100%;
        padding: 8px;
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        background: rgba(255, 255, 255, 1);
        margin: 0 0 10px 0;
        box-sizing: border-box;
      }

      .group-selector {
        width: 100%;
        padding: 8px;
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        background: rgba(255, 255, 255, 1);
        margin: 0 0 15px 0;
        box-sizing: border-box;
      }

      #board-content {
        flex: 1;
        overflow-y: auto;
        padding-right: 5px;
        box-sizing: border-box;
      }

      #board-content::-webkit-scrollbar {
        width: 6px;
      }

      #board-content::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 3px;
      }

      #board-content::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
      }

      #board-content::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
      }

      .post {
        background: rgba(255, 255, 255, 1);
        padding: 12px;
        margin-bottom: 12px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
        width: 100%;
        box-sizing: border-box;
      }

      .post-title {
        font-weight: bold;
        margin-bottom: 6px;
        color: #333;
        font-size: 14px;
      }

      .post-content {
        color: #666;
        margin-bottom: 8px;
        font-size: 13px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .post-group {
        display: inline-block;
        padding: 2px 6px;
        background: #e0e0e0;
        border-radius: 10px;
        font-size: 11px;
        color: #666;
        margin-bottom: 6px;
      }

      .post-time {
        font-size: 11px;
        color: #999;
        margin-bottom: 6px;
      }

      .delete-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
      }

      .delete-button:hover {
        background: #cc0000;
      }

      .fab {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #4caf50;
        color: white;
        border: none;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        z-index: 1000;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1001;
      }

      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 500px;
      }

      .modal-content h3 {
        margin: 0 0 15px 0;
        text-align: center;
      }

      .modal-content input,
      .modal-content textarea,
      .modal-content select {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        box-sizing: border-box;
      }

      .modal-content button {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        box-sizing: border-box;
      }

      .modal-content button.cancel {
        background: #666;
        margin-top: 10px;
      }

      .delete-confirm-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 300px;
        text-align: center;
        z-index: 1002;
      }

      .delete-confirm-dialog p {
        margin: 0 0 20px 0;
        color: #333;
      }

      .delete-confirm-dialog button {
        width: 100px;
        padding: 8px;
        margin: 0 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .delete-confirm-dialog button.confirm {
        background: #ff4444;
        color: white;
      }

      .delete-confirm-dialog button.cancel {
        background: #666;
        color: white;
      }

      .title-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .connection-status {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .connection-status::before {
        content: "wifi";
        font-family: "Material Icons";
        font-size: 20px;
        color: #666;
      }

      .connection-status.connected::before {
        color: #4caf50;
      }

      .post-form {
        background: rgba(255, 255, 255, 1);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .post-form input,
      .post-form textarea,
      .post-form select {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        box-sizing: border-box;
      }

      .post-form button {
        width: 100%;
        padding: 8px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .opacity-control {
        display: flex;
        align-items: center;
        margin-top: 5px;
      }

      .opacity-control label {
        margin-right: 5px;
        font-size: 12px;
        color: #333;
      }

      .opacity-control input[type="range"] {
        width: 100px;
        margin: 0;
      }

      .position-toggle:hover,
      .vertical-toggle:hover {
        color: #333;
      }

      .position-toggle svg {
        width: 16px;
        height: 16px;
      }
    </style>
  </head>
  <body>
    <div class="content">
      <div class="header">
        <div class="header-left">
          <div class="title-container">
            <h1 class="connection-status" id="connection-status"></h1>
            <h1>게시판</h1>
          </div>

          <div class="opacity-control">
            <label for="opacity">투명도</label>
            <input
              type="range"
              id="opacity"
              min="50"
              max="100"
              value="80"
              oninput="updateOpacity(this.value)"
            />
          </div>
        </div>
        <div class="header-right" style="font-size: 14px">
          <button class="vertical-toggle" onclick="toggleVertical()">
            expand_more
          </button>
          <button class="position-toggle" onclick="togglePosition()">
            chevron_right
          </button>
          <button class="close-button" onclick="window.close()">close</button>
        </div>
      </div>
      <div class="search-container">
        <input
          type="text"
          id="search-input"
          class="search-box"
          placeholder="검색..."
          oninput="searchPosts()"
        />
        <select
          id="group-filter"
          class="group-selector"
          onchange="filterPosts()"
        >
          <option value="">모든 게시글</option>
        </select>
      </div>
      <div class="post-form">
        <input type="text" id="new-title" placeholder="제목" />
        <textarea id="new-content" placeholder="내용"></textarea>
        <select id="new-group">
          <option value="">공통</option>
        </select>
        <button onclick="createPost()">게시</button>
      </div>
      <div id="board-content">
        <!-- 게시판 내용이 여기에 표시됩니다 -->
      </div>
    </div>
    <div class="modal" id="new-post-modal">
      <div class="modal-content">
        <h3>새 게시글 작성</h3>
        <input type="text" id="new-title" placeholder="제목" />
        <textarea id="new-content" placeholder="내용"></textarea>
        <select id="new-group">
          <option value="">공통</option>
        </select>
        <button onclick="createPost()">게시</button>
        <button
          onclick="hideNewPostModal()"
          style="margin-top: 10px; background: #666"
        >
          취소
        </button>
      </div>
    </div>
    <div class="modal" id="delete-confirm-modal">
      <div class="delete-confirm-dialog">
        <p>정말로 이 게시글을 삭제하시겠습니까?</p>
        <button class="confirm" onclick="confirmDeleteAction()">삭제</button>
        <button class="cancel" onclick="cancelDelete()">취소</button>
      </div>
    </div>
    <script>
      const { ipcRenderer } = require("electron");
      let socket = null;
      let isConnected = false;
      let currentGroup = "";
      let currentPosts = [];
      let deletePostId = null;
      let currentPosition = "left";
      let isVerticalExpanded = true;

      function connectWebSocket() {
        socket = new WebSocket("ws://localhost:8000/ws");
        const statusIndicator = document.getElementById("connection-status");

        socket.onopen = () => {
          console.log("WebSocket 연결됨");
          isConnected = true;
          statusIndicator.classList.add("connected");
          loadGroups();
        };

        socket.onclose = () => {
          console.log("WebSocket 연결 끊김");
          isConnected = false;
          statusIndicator.classList.remove("connected");
          setTimeout(connectWebSocket, 5000);
        };

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          handleWebSocketMessage(data);
        };

        socket.onerror = (error) => {
          console.error("WebSocket 오류:", error);
          statusIndicator.classList.remove("connected");
        };
      }

      async function loadGroups() {
        try {
          const response = await fetch("http://localhost:8000/groups");
          const data = await response.json();
          const groups = data.groups;

          const groupFilter = document.getElementById("group-filter");
          const newGroup = document.getElementById("new-group");

          // 기존 옵션 유지 (모든 게시글/공통)
          const filterOptions =
            groupFilter.innerHTML.split("</option>")[0] + "</option>";
          const newGroupOptions =
            newGroup.innerHTML.split("</option>")[0] + "</option>";

          groupFilter.innerHTML = filterOptions;
          newGroup.innerHTML = newGroupOptions;

          // 새로운 그룹 옵션 추가
          groups.forEach((group) => {
            if (group) {
              groupFilter.innerHTML += `<option value="${group}">${group}</option>`;
              newGroup.innerHTML += `<option value="${group}">${group}</option>`;
            }
          });
        } catch (error) {
          console.error("그룹 목록 가져오기 실패:", error);
        }
      }

      function filterPosts() {
        const groupFilter = document.getElementById("group-filter");
        currentGroup = groupFilter.value;
        updateDisplayedPosts();
      }

      function searchPosts() {
        updateDisplayedPosts();
      }

      function updateDisplayedPosts() {
        const searchInput = document.getElementById("search-input");
        const searchTerm = searchInput.value.toLowerCase();

        const filteredPosts = currentPosts.filter((post) => {
          const matchesGroup =
            !currentGroup || post.group === currentGroup || post.group === "";
          const matchesSearch =
            !searchTerm ||
            post.title.toLowerCase().includes(searchTerm) ||
            post.content.toLowerCase().includes(searchTerm);
          return matchesGroup && matchesSearch;
        });

        const boardContent = document.getElementById("board-content");
        boardContent.innerHTML = filteredPosts
          .map(
            (post) => `
          <div class="post">
            ${post.group ? `<div class="post-group">${post.group}</div>` : ""}
            <div class="post-time">${post.created_at}</div>
            <div class="post-title">${post.title}</div>
            <div class="post-content">${post.content}</div>
            <button class="delete-button" onclick="deletePost(${
              post.id
            })">X</button>
          </div>
        `
          )
          .join("");
      }

      function handleWebSocketMessage(data) {
        switch (data.type) {
          case "initial_posts":
            currentPosts = data.posts;
            updateDisplayedPosts();
            const initialOpacity = document.getElementById("opacity").value;
            updateOpacity(initialOpacity);
            break;
          case "new_post":
            currentPosts.unshift(data.post);
            updateDisplayedPosts();
            const newOpacity = document.getElementById("opacity").value;
            updateOpacity(newOpacity);
            break;
          case "delete_post":
            currentPosts = currentPosts.filter(
              (post) => post.id !== data.post_id
            );
            updateDisplayedPosts();
            const deleteOpacity = document.getElementById("opacity").value;
            updateOpacity(deleteOpacity);
            break;
        }
      }

      function showNewPostModal() {
        document.getElementById("new-post-modal").style.display = "block";
      }

      function hideNewPostModal() {
        document.getElementById("new-post-modal").style.display = "none";
      }

      function createPost() {
        const titleInput = document.getElementById("new-title");
        const contentInput = document.getElementById("new-content");
        const groupInput = document.getElementById("new-group");

        const title = titleInput.value.trim();
        const content = contentInput.value.trim();
        const group = groupInput.value.trim();

        if (!title || !content) {
          alert("제목과 내용을 모두 입력해주세요.");
          return;
        }

        fetch("http://localhost:8000/posts", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ title, content, group: group || "" }),
        })
          .then((response) => {
            if (response.ok) {
              titleInput.value = "";
              contentInput.value = "";
            } else {
              return response.json().then((data) => {
                throw new Error(data.detail || "알 수 없는 오류");
              });
            }
          })
          .catch((error) => {
            alert(`게시글 작성에 실패했습니다: ${error.message}`);
          });
      }

      function confirmDelete(postId) {
        deletePostId = postId;
        document.getElementById("delete-confirm-modal").style.display = "block";
      }

      function cancelDelete() {
        deletePostId = null;
        document.getElementById("delete-confirm-modal").style.display = "none";
      }

      async function confirmDeleteAction() {
        if (deletePostId) {
          await deletePost(deletePostId);
          document.getElementById("delete-confirm-modal").style.display =
            "none";
          deletePostId = null;
        }
      }

      async function deletePost(postId) {
        if (confirm("정말로 이 게시글을 삭제하시겠습니까?")) {
          try {
            const response = await fetch(
              `http://localhost:8000/posts/${postId}`,
              {
                method: "DELETE",
              }
            );

            if (!response.ok) {
              const errorData = await response.json();
              alert(
                `게시글 삭제에 실패했습니다: ${
                  errorData.detail || "알 수 없는 오류"
                }`
              );
            }
          } catch (error) {
            console.error("Error:", error);
            alert("게시글 삭제에 실패했습니다. 서버 연결을 확인해주세요.");
          }
        }
      }

      function updateOpacity(value) {
        const opacity = value / 100;
        const content = document.querySelector(".content");
        const postForm = document.querySelector(".post-form");
        const posts = document.querySelectorAll(".post");
        const header = document.querySelector(".header");
        const searchContainer = document.querySelector(".search-container");

        postForm.style.opacity = opacity;
        header.style.opacity = opacity;
        posts.forEach((post) => {
          post.style.opacity = opacity;
        });
        searchContainer.style.opacity = opacity;
      }

      // 초기 투명도 설정
      document.addEventListener("DOMContentLoaded", function () {
        updateOpacity(80);
        const verticalToggle = document.querySelector(".vertical-toggle");
        verticalToggle.textContent = isVerticalExpanded
          ? "expand_more"
          : "expand_less";
      });

      function togglePosition() {
        currentPosition = currentPosition === "left" ? "right" : "left";
        const positionToggle = document.querySelector(".position-toggle");
        positionToggle.textContent =
          currentPosition === "left" ? "chevron_right" : "chevron_left";
        ipcRenderer.send("change-position", currentPosition);
      }

      function toggleVertical() {
        isVerticalExpanded = !isVerticalExpanded;
        const verticalToggle = document.querySelector(".vertical-toggle");
        verticalToggle.textContent = isVerticalExpanded
          ? "expand_more"
          : "expand_less";
        ipcRenderer.send("toggle-vertical", isVerticalExpanded);

        // 컨텐츠 영역 표시/숨김 처리
        const content = document.querySelector(".content");
        if (isVerticalExpanded) {
          content.style.height = "100vh";
        } else {
          content.style.height = "auto";
        }
      }

      // WebSocket 연결 시작
      connectWebSocket();
    </script>
  </body>
</html>
